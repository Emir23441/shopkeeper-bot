import {
  Client,
  GatewayIntentBits,
  SlashCommandBuilder,
  REST,
  Routes,
  PermissionFlagsBits,
  EmbedBuilder
} from "discord.js";
import dotenv from "dotenv";
import fs from "fs";

dotenv.config();

const TOKEN = process.env.TOKEN;
const CLIENT_ID = process.env.CLIENT_ID;
const GUILD_ID = process.env.GUILD_ID;

const client = new Client({
  intents: [GatewayIntentBits.Guilds]
});

const dosyaYolu = "./urunler.json";

/* DOSYA */
function urunleriGetir() {
  if (!fs.existsSync(dosyaYolu)) fs.writeFileSync(dosyaYolu, "[]");
  return JSON.parse(fs.readFileSync(dosyaYolu));
}

function urunleriKaydet(liste) {
  fs.writeFileSync(dosyaYolu, JSON.stringify(liste, null, 2));
}

/* KOMUTLAR */
const commands = [

  new SlashCommandBuilder()
    .setName("urun-ekle")
    .setDescription("Yeni Ã¼rÃ¼n ekler (Admin)")
    .addStringOption(o =>
      o.setName("isim").setDescription("ÃœrÃ¼n adÄ±").setRequired(true))
    .addNumberOption(o =>
      o.setName("fiyat").setDescription("Fiyat").setRequired(true))
    .addIntegerOption(o =>
      o.setName("stok").setDescription("Stok miktarÄ±").setRequired(true))
    .setDefaultMemberPermissions(PermissionFlagsBits.Administrator),

  new SlashCommandBuilder()
    .setName("urun-sil")
    .setDescription("ÃœrÃ¼n siler (Admin)")
    .addStringOption(o =>
      o.setName("isim").setDescription("ÃœrÃ¼n adÄ±").setRequired(true))
    .setDefaultMemberPermissions(PermissionFlagsBits.Administrator),

  new SlashCommandBuilder()
    .setName("indirim-ayarla")
    .setDescription("Ä°ndirim ayarlar (Admin)")
    .addStringOption(o =>
      o.setName("isim").setDescription("ÃœrÃ¼n adÄ±").setRequired(true))
    .addIntegerOption(o =>
      o.setName("oran").setDescription("YÃ¼zde").setRequired(true))
    .setDefaultMemberPermissions(PermissionFlagsBits.Administrator),

  new SlashCommandBuilder()
    .setName("market")
    .setDescription("ÃœrÃ¼nleri listeler"),

  new SlashCommandBuilder()
    .setName("satinal")
    .setDescription("ÃœrÃ¼n satÄ±n al")
    .addStringOption(o =>
      o.setName("isim")
        .setDescription("SatÄ±n alÄ±nacak Ã¼rÃ¼n")
        .setRequired(true))

].map(c => c.toJSON());

const rest = new REST({ version: "10" }).setToken(TOKEN);

(async () => {
  await rest.put(
    Routes.applicationGuildCommands(CLIENT_ID, GUILD_ID),
    { body: commands }
  );
})();

/* KOMUT Ã‡ALIÅTIRMA */
client.on("interactionCreate", async interaction => {
  if (!interaction.isChatInputCommand()) return;

  let liste = urunleriGetir();

  // ÃœRÃœN EKLE
  if (interaction.commandName === "urun-ekle") {
    const isim = interaction.options.getString("isim");
    const fiyat = interaction.options.getNumber("fiyat");
    const stok = interaction.options.getInteger("stok");

    liste.push({ isim, fiyat, stok, indirim: 0 });
    urunleriKaydet(liste);

    return interaction.reply(`âœ… ${isim} eklendi.`);
  }

  // SATIN AL
  if (interaction.commandName === "satinal") {
    const isim = interaction.options.getString("isim");
    const urun = liste.find(u => u.isim === isim);

    if (!urun)
      return interaction.reply("âŒ ÃœrÃ¼n bulunamadÄ±.");

    if (urun.stok <= 0)
      return interaction.reply("ğŸš« Bu Ã¼rÃ¼n stokta yok.");

    // Stok dÃ¼ÅŸ
    urun.stok -= 1;
    urunleriKaydet(liste);

    let fiyat = urun.fiyat;
    let indirimli = fiyat - (fiyat * urun.indirim / 100);

    const embed = new EmbedBuilder()
      .setTitle("âœ… SatÄ±n Alma BaÅŸarÄ±lÄ±")
      .setColor(0x00ff00)
      .addFields(
        { name: "ÃœrÃ¼n", value: urun.isim, inline: true },
        { name: "Ã–denen Tutar", value: `${indirimli}â‚º`, inline: true },
        { name: "Kalan Stok", value: `${urun.stok}`, inline: true }
      )
      .setFooter({ text: interaction.user.username })
      .setTimestamp();

    return interaction.reply({ embeds: [embed] });
  }

  // MARKET
  if (interaction.commandName === "market") {
    if (liste.length === 0)
      return interaction.reply("ÃœrÃ¼n yok.");

    const embed = new EmbedBuilder()
      .setTitle("ğŸ›’ ShopKeeper Market")
      .setColor(0x0099ff)
      .setTimestamp();

    liste.forEach(urun => {
      let fiyat = urun.fiyat;
      let indirimli = fiyat - (fiyat * urun.indirim / 100);

      embed.addFields({
        name: `${urun.isim} (${urun.stok} adet)`,
        value:
          urun.indirim > 0
            ? `~~${fiyat}â‚º~~ â†’ **${indirimli}â‚º** ğŸ”¥`
            : `${fiyat}â‚º`,
        inline: false
      });
    });

    return interaction.reply({ embeds: [embed] });
  }
});

client.login(TOKEN);
